<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTB Label Verification System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app" class="p-4 sm:p-8">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                <!-- Header -->
                <div class="bg-indigo-600 text-white p-6">
                    <h1 class="text-3xl font-bold">TTB Label Verification System</h1>
                    <p class="mt-2 text-indigo-100">AI-Powered Alcohol Beverage Label Compliance Checker</p>
                </div>

                <div class="p-6 lg:p-8">
                    <div class="grid lg:grid-cols-2 gap-8">
                        <!-- Form Section -->
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Application Form</h2>
                            <form id="verificationForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Brand Name <span class="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        id="brandName"
                                        name="brandName"
                                        required
                                        placeholder="e.g., Old Tom Distillery"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Product Class/Type <span class="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        id="productType"
                                        name="productType"
                                        required
                                        placeholder="e.g., Kentucky Straight Bourbon Whiskey"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Alcohol Content (% ABV) <span class="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="number"
                                        id="alcoholContent"
                                        name="alcoholContent"
                                        required
                                        placeholder="e.g., 45"
                                        step="0.1"
                                        min="0"
                                        max="100"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Net Contents (Optional)
                                    </label>
                                    <input
                                        type="text"
                                        id="netContents"
                                        name="netContents"
                                        placeholder="e.g., 750 mL or 12 fl oz"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    />
                                </div>
                            </form>
                        </div>

                        <!-- Image Upload Section -->
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Label Image Upload</h2>
                            <div class="space-y-4">
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-400 transition-colors">
                                    <input
                                        type="file"
                                        accept="image/*"
                                        id="imageUpload"
                                        class="hidden"
                                    />
                                    <label for="imageUpload" class="cursor-pointer">
                                        <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        <p class="text-sm text-gray-600">Click to upload label image</p>
                                        <p class="text-xs text-gray-500 mt-1">PNG, JPG (max 5MB)</p>
                                    </label>
                                </div>

                                <div id="imagePreviewContainer" class="hidden">
                                    <p class="text-sm font-medium text-gray-700 mb-2">Preview:</p>
                                    <img id="imagePreview" alt="Label preview" class="w-full h-auto rounded-lg border border-gray-300" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-8 flex gap-4">
                        <button
                            id="verifyBtn"
                            type="button"
                            class="flex-1 bg-indigo-600 text-white py-3 px-6 rounded-md hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed font-medium transition-colors flex items-center justify-center gap-2"
                        >
                            Verify Label
                        </button>
                        <button
                            id="resetBtn"
                            type="button"
                            class="px-6 py-3 border border-gray-300 rounded-md hover:bg-gray-50 font-medium transition-colors"
                        >
                            Reset
                        </button>
                    </div>

                    <!-- Error Display -->
                    <div id="errorContainer" class="hidden mt-6 bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3">
                        <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p id="errorMessage" class="text-red-800"></p>
                    </div>

                    <!-- Results Display -->
                    <div id="resultsContainer" class="hidden mt-8 bg-gray-50 rounded-lg p-6">
                        <!-- Results will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-8 text-center text-gray-600 text-sm">
                <p>TTB Label Verification System - Demo Application</p>
                <p class="mt-1">Built for compliance verification demonstration purposes</p>
            </div>
        </div>
    </div>

    <script>
        let imageFile = null;
        let imagePreview = null;

        // Image upload handler
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                imageFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview = e.target.result;
                    document.getElementById('imagePreview').src = imagePreview;
                    document.getElementById('imagePreviewContainer').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
                hideError();
                hideResults();
            }
        });

        // Verify button handler
        document.getElementById('verifyBtn').addEventListener('click', async function() {
            const brandName = document.getElementById('brandName').value.trim();
            const productType = document.getElementById('productType').value.trim();
            const alcoholContent = document.getElementById('alcoholContent').value.trim();
            const netContents = document.getElementById('netContents').value.trim();

            if (!brandName || !productType || !alcoholContent) {
                showError('Please fill in all required fields (Brand Name, Product Type, and Alcohol Content).');
                return;
            }

            if (!imageFile) {
                showError('Please upload a label image.');
                return;
            }

            await analyzeLabel({brandName, productType, alcoholContent, netContents});
        });

        // Reset button handler
        document.getElementById('resetBtn').addEventListener('click', function() {
            document.getElementById('verificationForm').reset();
            document.getElementById('imageUpload').value = '';
            document.getElementById('imagePreviewContainer').classList.add('hidden');
            imageFile = null;
            imagePreview = null;
            hideError();
            hideResults();
        });

        async function analyzeLabel(formData) {
            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<div class="spinner"></div><span class="ml-2">Analyzing Label...</span>';
            hideError();
            hideResults();

            try {
                // Extract base64 data (remove data:image/jpeg;base64, prefix)
                const base64Data = imagePreview.split(',')[1];
                const mediaType = imageFile.type;
                
                // Call Netlify Function instead of Claude API directly
                const response = await fetch('/.netlify/functions/analyze-label', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image: {
                            data: base64Data,
                            mediaType: mediaType
                        },
                        formData: formData
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Function error:', errorData);
                    throw new Error(errorData.error || `Request failed with status ${response.status}`);
                }

                const results = await response.json();
                
                if (!results.readableImage) {
                    showError('âš  Could not read text from the label image. Please try a clearer image.');
                } else {
                    displayResults(results, formData);
                }
            } catch (err) {
                console.error('Analysis error:', err);
                showError(`An error occurred while analyzing the label: ${err.message}. Please try again.`);
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = 'Verify Label';
            }
        }

        function displayResults(results, formData) {
            const container = document.getElementById('resultsContainer');
            
            const statusClass = results.overallMatch ? 'text-green-800' : 'text-red-800';
            const statusBorder = results.overallMatch ? 'border-green-200' : 'border-red-200';
            const statusIcon = results.overallMatch 
                ? '<svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                : '<svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            const statusTitle = results.overallMatch ? 'Verification Successful' : 'Verification Failed';
            const statusMessage = results.overallMatch 
                ? 'The label matches the form data. All required information is consistent.'
                : 'The label does not match the form. See details below.';

            let html = `
                <div class="flex items-center gap-3 mb-6 pb-4 border-b ${statusBorder}">
                    ${statusIcon}
                    <div>
                        <h3 class="text-xl font-semibold ${statusClass}">${statusTitle}</h3>
                        <p class="${statusClass.replace('800', '700')}">${statusMessage}</p>
                    </div>
                </div>
                <h4 class="font-semibold text-gray-800 mb-4">Verification Details:</h4>
                <div class="space-y-3">
            `;

            const fields = [
                {key: 'brandName', label: 'Brand Name'},
                {key: 'productType', label: 'Product Class/Type'},
                {key: 'alcoholContent', label: 'Alcohol Content'},
                {key: 'netContents', label: 'Net Contents', optional: !formData.netContents},
                {key: 'governmentWarning', label: 'Government Warning Statement'}
            ];

            fields.forEach(field => {
                if (field.optional) return;
                
                const match = results.matches[field.key];
                const icon = match
                    ? '<svg class="w-5 h-5 text-green-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                    : '<svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                
                const extractedValue = results.extractedData[field.key];
                const foundText = extractedValue 
                    ? `<p class="text-xs text-gray-500 mt-1">Found on label: "${field.key === 'alcoholContent' ? extractedValue + '%' : extractedValue}"</p>`
                    : '';

                html += `
                    <div class="flex items-start gap-3 p-3 bg-white rounded-md">
                        ${icon}
                        <div class="flex-1">
                            <p class="font-medium text-gray-800">${field.label}</p>
                            <p class="text-sm text-gray-600 mt-1">${results.notes[field.key]}</p>
                            ${foundText}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
            container.classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorContainer').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorContainer').classList.add('hidden');
        }

        function hideResults() {
            document.getElementById('resultsContainer').classList.add('hidden');
        }
    </script>
</body>
</html>